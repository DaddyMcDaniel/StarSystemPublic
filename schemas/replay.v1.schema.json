/*
SUMMARY: Replay System Schema v1
=================================
Defines deterministic recording and playback of game sessions for testing and validation.
Enables exact reproduction of user interactions and system behaviors with identical seeds.

KEY COMPONENTS:
- session_metadata: Recording context and system state
- input_sequence: Chronological user actions with precise timing
- system_events: Deterministic system responses and state changes
- verification: Checksums and validation for replay integrity

USAGE:
- Created by tools.validators.replay_record during session capture
- Consumed by tools.validators.replay_play for exact reproduction
- Enables regression testing with realistic user scenarios
- Supports debugging by recreating exact failure conditions

RELATED FILES:
- tools: replay_record, replay_play
- artifacts: runs/{run_id}/replays/
- Essential for deterministic validation workflows
*/

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "urn:starsystem:schema:replay:v1",
  "version": 1,
  "title": "Replay System Schema",
  "description": "Deterministic recording and playback of game sessions for testing validation",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "session_metadata": {
      "type": "object",
      "description": "Recording context and system state",
      "additionalProperties": false,
      "properties": {
        "replay_id": {"type": "string"},
        "recorded_at": {"type": "string", "format": "date-time"},
        "duration_ms": {"type": "integer", "minimum": 0},
        "global_seed": {"type": "integer", "minimum": 0},
        "world_seed": {"type": "integer", "minimum": 0},
        "system_version": {"type": "string"},
        "platform": {"type": "string", "enum": ["web", "native", "mobile"]},
        "initial_state_hash": {"type": "string"}
      },
      "required": ["replay_id", "recorded_at", "global_seed", "world_seed"]
    },
    "input_sequence": {
      "type": "array",
      "description": "Chronological user actions with precise timing",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "timestamp_ms": {"type": "integer", "minimum": 0},
          "input_type": {"type": "string", "enum": ["mouse_click", "mouse_move", "key_press", "key_release", "touch", "gesture"]},
          "data": {
            "type": "object",
            "properties": {
              "position": {"type": "object", "properties": {"x": {"type": "number"}, "y": {"type": "number"}}},
              "button": {"type": "string"},
              "key_code": {"type": "string"},
              "modifiers": {"type": "array", "items": {"type": "string"}},
              "pressure": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        },
        "required": ["timestamp_ms", "input_type", "data"]
      }
    },
    "system_events": {
      "type": "array",
      "description": "Deterministic system responses and state changes",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "timestamp_ms": {"type": "integer", "minimum": 0},
          "event_type": {"type": "string", "enum": ["state_change", "render_frame", "physics_step", "ai_decision", "resource_load"]},
          "data": {"type": "object"},
          "state_hash": {"type": "string"}
        },
        "required": ["timestamp_ms", "event_type", "data"]
      }
    },
    "checkpoints": {
      "type": "array",
      "description": "Periodic state snapshots for validation",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "timestamp_ms": {"type": "integer", "minimum": 0},
          "state_hash": {"type": "string"},
          "world_state": {"type": "object"},
          "camera_position": {"type": "object", "properties": {"x": {"type": "number"}, "y": {"type": "number"}, "z": {"type": "number"}}}
        },
        "required": ["timestamp_ms", "state_hash"]
      }
    },
    "verification": {
      "type": "object",
      "description": "Replay integrity validation",
      "additionalProperties": false,
      "properties": {
        "final_state_hash": {"type": "string"},
        "total_inputs": {"type": "integer", "minimum": 0},
        "total_events": {"type": "integer", "minimum": 0},
        "checksum": {"type": "string"},
        "is_deterministic": {"type": "boolean"}
      },
      "required": ["final_state_hash", "total_inputs", "total_events"]
    }
  },
  "required": ["session_metadata", "input_sequence", "verification"]
}